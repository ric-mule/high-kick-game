<script>
(function(){
  const GAME_ROOM_URL = 'https://alabamabluesman.com/live-bingo-game-room';
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxvAlRjAj3f11KIGzwOMhxud-PGrMhsw5PWKEPIqKylj8PQp0ZBpxBPFUAD2Ktx_i0/exec';

  const sanitize = s => String(s||'').replace(/[<>"'`]/g,'');
  function normalizeHandle(s){ s=String(s||'').trim(); if(!s) return ''; return s.startsWith('@')?s:'@'+s.replace(/^@+/, '') }
  function toISOForTodayLocal(hhmm){
    if(!hhmm) return ''; const [hh,mm]=hhmm.split(':').map(Number);
    const now=new Date(); const d=new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
    const pad=n=>String(n).padStart(2,'0'); const off=-d.getTimezoneOffset();
    const sign=off>=0?'+':'-'; const tzH=pad(Math.floor(Math.abs(off)/60)); const tzM=pad(Math.abs(off)%60);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(hh)}:${pad(mm)}:00${sign}${tzH}:${tzM}`;
  }
  function isoToHHMM(iso){ if(!iso) return ''; const d=new Date(iso), pad=n=>String(n).padStart(2,'0'); return `${pad(d.getHours())}:${pad(d.getMinutes())}` }
  function b64urlEncode(str){ return btoa(unescape(encodeURIComponent(str))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'') }
  function b64urlDecode(str){ str=str.replace(/-/g,'+').replace(/_/g,'/'); const pad=str.length%4?4-(str.length%4):0; return decodeURIComponent(escape(atob(str+'='.repeat(pad)))) }

  const padEl = document.getElementById('pad');
  const previewTop = document.getElementById('previewTop');
  const previewBottom = document.getElementById('previewBottom');
  const alertEl = document.getElementById('alert');
  const msgEl = document.getElementById('msg');

  const form = document.getElementById('bzForm');
  const fName = document.getElementById('f_name');
  const fEmail = document.getElementById('f_email');
  const fTikTok = document.getElementById('f_tiktok');
  const fLocked = document.getElementById('f_locked');
  const fLockedHidden = document.getElementById('f_locked_hidden');
  const fGameLock = document.getElementById('f_game_lock');
  const fSelectedHidden = document.getElementById('f_selected_hidden');
  const fJsonHidden = document.getElementById('f_json_hidden');

  const fRow1 = document.getElementById('f_row1');
  const fRow2 = document.getElementById('f_row2');
  const fRow3 = document.getElementById('f_row3');
  const fRow4 = document.getElementById('f_row4');
  const fRow5 = document.getElementById('f_row5');
  const fColB = document.getElementById('f_colB');
  const fColI = document.getElementById('f_colI');
  const fColN = document.getElementById('f_colN');
  const fColG = document.getElementById('f_colG');
  const fColO = document.getElementById('f_colO');

  const fRemember = document.getElementById('f_remember');
  const forgetLink = document.getElementById('forget_link');
  const REM_KEY = 'bingo_player_v1';

  const fNotify = document.getElementById('f_notify');
  const fGameTime = document.getElementById('f_game_time');
  const fNotifyH = document.getElementById('f_notify_h');
  const fGameTimeH = document.getElementById('f_game_time_h');
  const fCardId = document.getElementById('f_card_id');

  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');
  const linkBtn = document.getElementById('linkBtn');

  const state = { picks:new Set(), grid:[] };

  // Prefill remembered
  try{
    const saved = JSON.parse(localStorage.getItem(REM_KEY) || '{}');
    if(saved && (saved.name||saved.email||saved.tiktok)){
      if(saved.name) fName.value=saved.name;
      if(saved.email) fEmail.value=saved.email;
      if(saved.tiktok) fTikTok.value=saved.tiktok;
      if(fRemember) fRemember.checked=true;
    }
  }catch(e){}

  // Build number pad 1..100 (buttons)
  for(let n=1;n<=100;n++){
    const b=document.createElement('button');
    b.type='button'; b.className='num'; b.textContent=n; b.dataset.n=n;
    b.setAttribute('aria-pressed','false'); b.setAttribute('role','gridcell');
    b.addEventListener('click',()=>togglePick(n,b));
    b.addEventListener('keydown',(e)=>{
      const idx=n-1,row=Math.floor(idx/10),col=idx%10; let target=n;
      if(e.key==='ArrowRight'&&col<9)target=n+1;
      else if(e.key==='ArrowLeft'&&col>0)target=n-1;
      else if(e.key==='ArrowDown'&&row<9)target=n+10;
      else if(e.key==='ArrowUp'&&row>0)target=n-10;
      if(target!==n){ padEl.querySelector(`.num[data-n="${target}"]`)?.focus(); e.preventDefault(); }
    });
    padEl.appendChild(b);
  }

  function togglePick(n,btn){
    alertEl.textContent='';
    if(state.picks.has(n)){ state.picks.delete(n); btn.classList.remove('sel'); btn.setAttribute('aria-pressed','false'); }
    else{
      if(state.picks.size>=25){ alertEl.textContent='Select exactly 25.'; return; }
      state.picks.add(n); btn.classList.add('sel'); btn.setAttribute('aria-pressed','true');
    }
    syncAll();
  }

  function buildGrid(){
    let arr=Array.from(state.picks).sort((a,b)=>a-b);
    while(arr.length<25) arr.push('');
    const g=[]; let k=0;
    for(let r=0;r<5;r++){ const row=[]; for(let c=0;c<5;c++){ row.push(arr[k++]); } g.push(row); }
    state.grid=g;
  }
  function render(tbody){
    tbody.innerHTML=''; const g=state.grid;
    for(let r=0;r<5;r++){ const tr=document.createElement('tr');
      for(let c=0;c<5;c++){ const td=document.createElement('td'); td.textContent=g[r][c]; tr.appendChild(td); }
      tbody.appendChild(tr);
    }
  }
  function rowsAndCols(g){
    const rows=g.map(r=>r.map(x=>x===''?'':String(x)).join(' '));
    const cols=[0,1,2,3,4].map(c=>g.map(r=>r[c]).map(x=>x===''?'':String(x)).join(' '));
    return {rows,cols};
  }

  function newCardId(){ return (crypto.randomUUID? crypto.randomUUID():('cid_'+Date.now()+'_'+Math.random().toString(16).slice(2))); }
  if(!fCardId.value) fCardId.value=newCardId();

  function syncMetaFields(){
    if (fNotifyH) fNotifyH.value = (fNotify && fNotify.checked) ? 'true' : 'false';
    if (fGameTimeH) fGameTimeH.value = toISOForTodayLocal(fGameTime?.value || '');
  }

  function payload(){
    syncMetaFields();
    return {
      page:'builder', type:'number-bingo-1-100',
      selected:Array.from(state.picks).sort((a,b)=>a-b),
      grid:state.grid,
      user:{
        name:sanitize(fName.value.trim()),
        email:sanitize(fEmail.value.trim()),
        tiktok:sanitize(normalizeHandle(fTikTok.value.trim()))
      },
      locked:fLocked.checked,
      game_lock:fGameLock.value.trim().replace(/\D+/g,'').slice(0,8),
      card_id:fCardId.value,
      notify:(fNotify && fNotify.checked) ? true:false,
      game_time:fGameTimeH.value,
      timestamp:Date.now(),
      submitted_at:new Date().toISOString(),
      ua:navigator.userAgent,
      version:'2025-11-02-holiday'
    };
  }

  function pushIntoForm(){
    const pl=payload();
    if(fCardId) fCardId.value=pl.card_id;
    if(fNotifyH) fNotifyH.value=pl.notify?'true':'false';
    if(fGameTimeH) fGameTimeH.value=pl.game_time||'';
    fSelectedHidden.value=pl.selected.join(', ');
    fJsonHidden.value=JSON.stringify(pl,null,2);
    fLockedHidden.value=pl.locked?'true':'false';
    const {rows,cols}=rowsAndCols(pl.grid);
    fRow1.value=rows[0]; fRow2.value=rows[1]; fRow3.value=rows[2]; fRow4.value=rows[3]; fRow5.value=rows[4];
    fColB.value=cols[0]; fColI.value=cols[1]; fColN.value=cols[2]; fColG.value=cols[3]; fColO.value=cols[4];
    try{ localStorage.setItem('bingo_card_last', JSON.stringify(pl)); }catch(e){}
  }

  function syncAll(){
    document.getElementById('count').textContent=`Selected: ${state.picks.size} / 25`;
    buildGrid(); render(previewTop); render(previewBottom); pushIntoForm();
  }

  function buildFlatPayload(pl){
    const {rows,cols}=rowsAndCols(pl.grid);
    return {
      name:pl.user.name, email:pl.user.email, tiktok:pl.user.tiktok,
      card_id:pl.card_id, notify:pl.notify?'true':'false', game_time_iso:pl.game_time,
      selected_numbers:pl.selected.join(', '), grid_json:JSON.stringify(pl),
      locked:pl.locked?'true':'false', game_lock:pl.game_lock,
      page:pl.page, type:pl.type, timestamp:String(pl.timestamp), submitted_at:pl.submitted_at, ua:pl.ua,
      row_1:rows[0], row_2:rows[1], row_3:rows[2], row_4:rows[3], row_5:rows[4],
      col_B:cols[0], col_I:cols[1], col_N:cols[2], col_G:cols[3], col_O:cols[4],
    };
  }

  function celebrateConfetti(bursts=1){
    const layer=document.getElementById('confetti-layer')||(()=>{const d=document.createElement('div');d.id='confetti-layer';document.body.appendChild(d);return d})();
    const colors=['#F87171','#FBBF24','#34D399','#60A5FA','#A78BFA','#F472B6','#FDE68A','#22D3EE']; const W=window.innerWidth;
    for(let b=0;b<bursts;b++){ const frag=document.createDocumentFragment();
      for(let i=0;i<120;i++){ const el=document.createElement('div'); el.className='confetti';
        const size=8+Math.random()*8; el.style.width=size+'px'; el.style.height=(size*1.35)+'px';
        el.style.background = Math.random()<0.25 ? `linear-gradient(180deg, ${colors[i%colors.length]}, #fff)` : colors[(i+Math.floor(Math.random()*colors.length))%colors.length];
        const startX=(Math.random()*W)+'px'; el.style.setProperty('--x',startX); el.style.setProperty('--dx',(Math.random()*160-80)+'px'); el.style.setProperty('--dur',(700+Math.random()*900)+'ms');
        el.style.left=0; el.style.transform=`translate3d(${startX},-10%,0)`; el.addEventListener('animationend',()=>el.remove()); frag.appendChild(el);
      } layer.appendChild(frag);
    }
  }

  // *** BULLETPROOF SENDER: hidden form â†’ iframe (no CORS, no 405) ***
  function postToGoogle(pl){
    const flat = buildFlatPayload(pl);
    try{
      const tmpForm=document.createElement('form');
      tmpForm.style.display='none';
      tmpForm.method='POST';
      tmpForm.action=GOOGLE_SCRIPT_URL;
      tmpForm.target='silent_post_iframe';
      for(const [k,v] of Object.entries(flat)){
        const input=document.createElement('input');
        input.type='hidden'; input.name=k; input.value=v; tmpForm.appendChild(input);
      }
      document.body.appendChild(tmpForm);
      tmpForm.submit();
      setTimeout(()=>tmpForm.remove(),1500);
      return Promise.resolve(true);
    }catch(_){ return Promise.resolve(true); }
  }

  // Buttons
  document.getElementById('randBtn').addEventListener('click', ()=>{
    state.picks.clear(); padEl.querySelectorAll('.num.sel').forEach(el=>{el.classList.remove('sel'); el.setAttribute('aria-pressed','false')});
    const pool=[...Array(100)].map((_,i)=>i+1);
    for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
    pool.slice(0,25).forEach(n=>{ state.picks.add(n); const cell=padEl.querySelector(`.num[data-n="${n}"]`); if(cell){ cell.classList.add('sel'); cell.setAttribute('aria-pressed','true'); }});
    syncAll(); const first=Array.from(state.picks).sort((a,b)=>a-b)[0]; padEl.querySelector(`.num[data-n="${first}"]`)?.focus();
  });
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    state.picks.clear(); padEl.querySelectorAll('.num.sel').forEach(el=>{el.classList.remove('sel'); el.setAttribute('aria-pressed','false')}); syncAll();
  });

  ['input','change'].forEach(evt=>{
    fName.addEventListener(evt,pushIntoForm);
    fEmail.addEventListener(evt,pushIntoForm);
    fTikTok.addEventListener(evt,()=>{ fTikTok.value=normalizeHandle(fTikTok.value); pushIntoForm(); });
    fLocked.addEventListener(evt,pushIntoForm);
    fGameLock.addEventListener(evt,()=>{ fGameLock.value=fGameLock.value.replace(/\D+/g,'').slice(0,8); pushIntoForm(); });
    if(fNotify) fNotify.addEventListener(evt,()=>{ syncMetaFields(); pushIntoForm(); });
    if(fGameTime) fGameTime.addEventListener(evt,()=>{ syncMetaFields(); pushIntoForm(); });
  });

  function saveRemembered(){
    if(!fRemember || !fRemember.checked) return;
    const data={ name:fName.value.trim(), email:fEmail.value.trim(), tiktok:normalizeHandle(fTikTok.value.trim()) };
    try{ localStorage.setItem(REM_KEY, JSON.stringify(data)); }catch(e){}
  }
  if(fRemember){
    [fName,fEmail,fTikTok].forEach(el=>{ el.addEventListener('input',saveRemembered); el.addEventListener('change',saveRemembered); });
    fRemember.addEventListener('change', ()=>{ if(!fRemember.checked) localStorage.removeItem(REM_KEY); else saveRemembered(); });
  }
  if(forgetLink){
    const clearSaved=()=>{ localStorage.removeItem(REM_KEY); if(fRemember) fRemember.checked=false; alert('All rightâ€”info cleared on this device.') };
    forgetLink.addEventListener('click', e=>{ e.preventDefault(); clearSaved(); });
    forgetLink.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); clearSaved(); }});
  }

  const SAVE_KEY='bingo_card_saved_v2';
  function saveCurrentCardLocal(){
    if(state.picks.size!==25){ alert('Pick exactly 25 numbers first, sugar.'); return; }
    const pl=payload();
    const pack={ picks:pl.selected, user:pl.user, locked:pl.locked, game_lock:pl.game_lock, card_id:pl.card_id, game_time:pl.game_time, notify:pl.notify, saved_at:Date.now(), v:'v2' };
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(pack)); alert('Card saved on this device. Hit â€œLoad Savedâ€ later.'); }catch(e){ alert('Couldnâ€™t save on this device.'); }
  }
  function loadSavedCardLocal(){
    try{
      const raw=localStorage.getItem(SAVE_KEY); if(!raw) return alert('No saved card on this device yet.');
      const pack=JSON.parse(raw);
      state.picks.clear(); padEl.querySelectorAll('.num.sel').forEach(el=>{el.classList.remove('sel'); el.setAttribute('aria-pressed','false')});
      (pack.picks||[]).forEach(n=>{ state.picks.add(Number(n)); const cell=padEl.querySelector(`.num[data-n="${n}"]`); if(cell){ cell.classList.add('sel'); cell.setAttribute('aria-pressed','true'); }});
      fName.value=pack.user?.name||''; fEmail.value=pack.user?.email||''; fTikTok.value=pack.user?.tiktok||'';
      fLocked.checked=!!pack.locked; fGameLock.value=pack.game_lock||'';
      if(pack.card_id) fCardId.value=pack.card_id;
      if(pack.game_time){ fGameTimeH.value=pack.game_time; const hhmm=isoToHHMM(pack.game_time); if(hhmm) fGameTime.value=hhmm; }
      if(typeof pack.notify==='boolean') fNotify.checked=pack.notify;
      syncAll(); alert('Loaded your saved card. Ready to roll.');
    }catch(e){ alert('Couldnâ€™t load the saved card.'); }
  }
  saveBtn?.addEventListener('click', saveCurrentCardLocal);
  loadBtn?.addEventListener('click', loadSavedCardLocal);

  function buildMagicLink(){
    if(state.picks.size!==25){ alert('Pick exactly 25 numbers first.'); return null; }
    const pl=payload();
    const minimal={ p:pl.selected, u:pl.user, l:pl.locked, g:pl.game_lock, id:pl.card_id, n:pl.notify };
    const hash=b64urlEncode(JSON.stringify(minimal));
    return `${location.origin}${location.pathname}#card=${hash}`;
  }
  function applyFromHash(){
    const m=location.hash.match(/#card=([^&]+)/); if(!m) return;
    try{
      const decoded=JSON.parse(b64urlDecode(m[1]));
      state.picks.clear(); padEl.querySelectorAll('.num.sel').forEach(el=>{el.classList.remove('sel'); el.setAttribute('aria-pressed','false')});
      (decoded.p||[]).forEach(n=>{ state.picks.add(Number(n)); const cell=padEl.querySelector(`.num[data-n="${n}"]`); if(cell){ cell.classList.add('sel'); cell.setAttribute('aria-pressed','true'); }});
      fName.value=decoded.u?.name||''; fEmail.value=decoded.u?.email||''; fTikTok.value=decoded.u?.tiktok||'';
      fLocked.checked=!!decoded.l; fGameLock.value=decoded.g||''; if(decoded.id) fCardId.value=decoded.id;
      if(typeof decoded.n==='boolean') fNotify.checked=decoded.n;
      syncAll(); history.replaceState(null,'',location.pathname+location.search); alert('Loaded your card from magic link.');
    }catch(_){}
  }
  linkBtn?.addEventListener('click', ()=>{
    const link=buildMagicLink(); if(!link) return;
    (navigator.clipboard?.writeText(link) || Promise.reject()).then(()=>alert('Magic link copied. Bookmark or DM it to yourself.'),()=>prompt('Copy your magic link:', link));
  });
  applyFromHash();

  (function promptLoad(){
    if(!localStorage.getItem(SAVE_KEY)) return;
    setTimeout(()=>{ if(confirm('We found a saved card on this device. Load it now?')) loadSavedCardLocal(); }, 400);
  })();

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if(!fName.value.trim() || !fEmail.value.trim()){ alertEl.textContent='Name and email are required.'; return; }
    if(state.picks.size!==25){ alertEl.textContent='Please select exactly 25 numbers before submitting.'; return; }
    pushIntoForm();
    const submitBtn=form.querySelector('button[type="submit"]');
    [submitBtn, saveBtn, loadBtn, linkBtn].forEach(b=>b?.setAttribute('disabled',''));
    msgEl.textContent='Sendingâ€¦';

    const pl=payload();
    try{
      localStorage.setItem('bingo_notify_optin', pl.notify?'yes':'no');
      localStorage.setItem('last_submit_card_id', pl.card_id);
    }catch(e){}
    await postToGoogle(pl);

    if(pl.notify) msgEl.textContent='Weâ€™ll remind you before future games. âœ“';
    celebrateConfetti(1);

    // ðŸ” Pack the card data so the card-only game room can rebuild everything inside Bandzoogle
    const packed = b64urlEncode(JSON.stringify({
      grid: pl.grid,
      user: pl.user,
      card_id: pl.card_id
    }));

    setTimeout(()=>{
      window.location.href =
        GAME_ROOM_URL
        + '?card='   + encodeURIComponent(pl.card_id)
        + '&packed=' + encodeURIComponent(packed);
    }, 900);
  });

  // init
  syncAll();
})();
</script>
