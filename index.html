<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Build Your Funky Bingo Card ‚Äî Holiday Edition</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  :root{
    --bg1:#061a1a; --bg2:#0b2a2a; --frost:#0d3640;
    --red:#e11d48; --green:#16a34a; --gold:#fbbf24;
    --snow:rgba(255,255,255,.7); --ring:rgba(45,212,191,.5);
  }
  body{
    margin:0;
    background:
      radial-gradient(1200px 800px at 10% -10%, #103, transparent 60%),
      radial-gradient(1000px 700px at 90% -20%, #013, transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
    min-height:100vh;color:#f8fafc;
  }
  .snow{pointer-events:none;position:fixed;inset:0;z-index:0;opacity:.4;
    background-image:
      radial-gradient(2px 2px at 20px 30px, var(--snow) 50%, transparent 51%),
      radial-gradient(2px 2px at 80px 120px, var(--snow) 50%, transparent 51%),
      radial-gradient(2px 2px at 200px 80px, var(--snow) 50%, transparent 51%),
      radial-gradient(2px 2px at 320px 200px, var(--snow) 50%, transparent 51%),
      radial-gradient(2px 2px at 480px 100px, var(--snow) 50%, transparent 51%);
    background-size:600px 600px,700px 700px,800px 800px,900px 900px,1000px 1000px;
    animation:snowfall 18s linear infinite;}
  @keyframes snowfall{
    0%{background-position:0 0,0 0,0 0,0 0,0 0;}
    100%{background-position:0 600px,0 700px,0 800px,0 900px,0 1000px;}
  }
  @media (prefers-reduced-motion: reduce){
    .snow{animation:none}.confetti{animation:none !important;opacity:0 !important}
  }
  #confetti-layer{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:9999}
  .confetti{position:absolute;width:10px;height:14px;opacity:0;border-radius:2px;will-change:transform,opacity;animation:confetti-fall var(--dur,900ms) ease-out forwards}
  @keyframes confetti-fall{
    0%{transform:translate3d(var(--x,0),-10%,0) rotate(0deg);opacity:1}
    100%{transform:translate3d(calc(var(--x,0) + var(--dx,0)),110%,0) rotate(720deg);opacity:0}
  }

  #billiobingo{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:18px 18px 30px}
  .frost{
    background:rgba(6,18,20,.8);
    backdrop-filter:blur(6px);
    border-radius:14px;
    border:1px solid rgba(251,191,36,.9);
    box-shadow:
      0 10px 30px rgba(0,0,0,.35),
      0 0 24px rgba(250,250,250,.12),
      inset 0 1px 0 rgba(255,255,255,.06);
    padding:18px;
  }

  #billiobingo *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif}
  #billiobingo h1{margin:6px 0 8px;font-size:28px;letter-spacing:.3px}
  #billiobingo h2{margin:16px 0 8px;font-size:18px;color:#e2e8f0}
  #billiobingo .muted{color:#b6c2d1;font-size:12px}
  #billiobingo .two-col{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
  @media (max-width:900px){#billiobingo .two-col{grid-template-columns:1fr}}

  .garland{margin:4px 0 12px;height:46px;display:flex;align-items:flex-end;gap:10px;position:relative}
  .garland .lights{width:100%;height:36px}
  .tagline{position:absolute;right:8px;top:-6px;background:linear-gradient(180deg,#134e4a,#052e2b);color:#eafff8;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-weight:700;font-size:12px;box-shadow:0 6px 14px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.08)}

  #billiobingo .pad{display:grid;grid-template-columns:repeat(10,1fr);gap:6px}
  #billiobingo .num{
    appearance:none;-webkit-appearance:none;border:1px solid #34525a;border-radius:8px;padding:12px 0;text-align:center;
    cursor:pointer;user-select:none;background:rgba(255,255,255,.06);color:#e6f6ff;font-weight:800;font-size:15px;letter-spacing:.2px;
    transition:transform .12s, background .15s, color .15s, border-color .15s, box-shadow .15s;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.05), 0 1px 1px rgba(0,0,0,.25)
  }
  #billiobingo .num:hover{background:rgba(255,255,255,.12);border-color:#4aa3b2;box-shadow:0 0 0 3px rgba(45,212,191,.18);transform:translateY(-1px)}
  #billiobingo .num.sel{
    background:linear-gradient(180deg,#16a34a,#0e7a3a);color:#fff;border-color:#0e7a3a;box-shadow:0 0 0 3px rgba(22,163,74,.28), 0 6px 16px rgba(0,0,0,.25)
  }
  #billiobingo .num:focus-visible, #billiobingo .btn:focus-visible{outline:0;box-shadow:0 0 0 3px var(--ring), 0 0 0 1px #0e7a3a inset}

  #billiobingo .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0 14px}
  #billiobingo .btn{
    background:linear-gradient(180deg,#0f172a,#0b1220);color:#fff;border:1px solid #203041;border-radius:10px;
    padding:10px 16px;cursor:pointer;font-weight:800;letter-spacing:.2px;box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 6px 14px rgba(0,0,0,.25);
    transition:transform .1s, box-shadow .1s, background .1s;
  }
  #billiobingo .btn[disabled]{opacity:.6;cursor:not-allowed}
  #billiobingo .btn:hover{transform:translateY(-1px);box-shadow:0 9px 18px rgba(0,0,0,.4)}

  #randBtn{background:linear-gradient(180deg,#fce7f3,#f9a8d4 60%, #fb7185);color:#2b0c14;border-color:#be185d;text-shadow:0 1px 0 rgba(255,255,255,.35)}
  #clearBtn{background:linear-gradient(180deg,#e2e8f0,#cbd5e1);color:#0b1220;border-color:#64748b}

  /* ‚ú® Highlight Save for Later button */
  #saveBtn{
    background:linear-gradient(180deg,#facc15,#f97316);
    color:#451a03;
    border-color:#ea580c;
    text-shadow:0 1px 0 rgba(255,255,255,.6);
  }
  #saveBtn:hover{
    box-shadow:0 0 0 3px rgba(250,204,21,.35),0 12px 22px rgba(0,0,0,.45);
    transform:translateY(-2px);
  }

  #billiobingo .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.12);color:#e6f6ff;font-weight:800;border:1px solid rgba(255,255,255,.18)}
  #billiobingo .warn{color:#fda4af}

  #billiobingo .grid{
    border-collapse:separate;border-spacing:0;width:100%;max-width:480px;overflow:hidden;border-radius:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.35), 0 0 0 2px rgba(250,250,250,.06);
  }
  #billiobingo .grid th{
    background:linear-gradient(180deg,var(--red),var(--green));
    color:#fef9c3;padding:12px;border-bottom:1px solid rgba(255,255,255,.18);font-size:15px;letter-spacing:.6px;text-shadow:0 1px 0 rgba(0,0,0,.45)
  }
  #billiobingo .grid td{
    background:rgba(15,23,42,.9);color:#e6f6ff;font-weight:700;padding:12px;border:1px solid rgba(148,163,184,.4);text-align:center
  }

  #billiobingo .mini{border-collapse:separate;border-spacing:0;width:100%;margin-top:8px;overflow:hidden;border-radius:10px}
  #billiobingo .mini td,#billiobingo .mini th{border:1px solid rgba(255,255,255,.08);padding:6px;text-align:center;font-size:12px;background:rgba(15,23,42,.7);color:#dbeafe}

  #billiobingo input, #billiobingo textarea, #billiobingo select{
    width:100%;padding:10px 12px;border:1px solid #2a4147;border-radius:8px;background:rgba(255,255,255,.06);color:#e7f5ff
  }
  #billiobingo input::placeholder{color:#98a6b3}
  #billiobingo label{font-size:13px;margin:8px 0 4px;display:block;color:#e2e8f0}

  #billiobingo .brand{display:flex;align-items:center;gap:12px;margin:10px 0 6px}
  #billiobingo .brand img{height:52px;width:auto;display:block;filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
  .brand h1{display:flex;align-items:center;gap:8px}
  .brand h1 .holly{font-size:20px;background:linear-gradient(180deg,#14532d,#052e2b);padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12)}

  #billiobingo .remember-row{display:flex;gap:8px;align-items:center;margin:6px 0 4px}
  #billiobingo .forget-link{font-size:12px;color:#cbd5e1;text-decoration:underline;cursor:pointer}
  #billiobingo .section{margin-top:18px}
  .holiday-footer{margin-top:10px;display:flex;align-items:center;gap:10px;color:#e2e8f0;font-size:12px}
  #billiobingo .footer{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  #billiobingo .optin input[type="checkbox"]{width:16px;height:16px;margin-top:2px}
  #billiobingo .optin span{font-size:12px;color:#cbd5e1;line-height:1.25}

  /* üéÑ Badge style for holiday flair */
  .badge{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:4px 10px;
    border-radius:999px;
    font-size:11px;
    background:linear-gradient(90deg,#f97316,#facc15);
    color:#451a03;
    border:1px solid rgba(250,204,21,.9);
    text-transform:uppercase;
    letter-spacing:.08em;
  }

  /* üéÑ Softer ‚ÄúSave your card‚Äù strip */
  .save-strip{
    display:flex;
    align-items:center;
    gap:8px;
    margin:14px 0 10px;
    padding:8px 12px;
    border-radius:999px;
    background:rgba(15,23,42,.9);
    border:1px solid rgba(148,163,184,.7);
    box-shadow:0 4px 10px rgba(15,23,42,.7);
  }
  .save-strip::before{
    content:"üéÑ";
    font-size:16px;
  }
  .save-strip label{
    margin:0;
    font-weight:600;
    color:#e5e7eb;
  }
</style>
</head>
<body>
<div class="snow" aria-hidden="true"></div>
<div id="confetti-layer" aria-hidden="true"></div>

<!-- Hidden target for classic form POST (bulletproof send) -->
<iframe name="silent_post_iframe" style="display:none;width:0;height:0;border:0" aria-hidden="true"></iframe>

<div id="billiobingo">
  <div class="frost">
    <div class="garland" aria-hidden="true">
      <svg class="lights" viewBox="0 0 600 60" preserveAspectRatio="none">
        <defs>
          <linearGradient id="glowR" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#ff8fa3"/><stop offset="1" stop-color="#e11d48"/></linearGradient>
          <linearGradient id="glowG" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#86efac"/><stop offset="1" stop-color="#16a34a"/></linearGradient>
          <linearGradient id="glowY" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#fde68a"/><stop offset="1" stop-color="#f59e0b"/></linearGradient>
        </defs>
        <path d="M0,20 C100,60 200,-10 300,20 400,50 500,-10 600,20" fill="none" stroke="#134e4a" stroke-width="4"/>
        <g>
          <ellipse cx="60" cy="30" rx="8" ry="12" fill="url(#glowR)"/>
          <ellipse cx="140" cy="18" rx="8" ry="12" fill="url(#glowG)"/>
          <ellipse cx="220" cy="32" rx="8" ry="12" fill="url(#glowY)"/>
          <ellipse cx="300" cy="18" rx="8" ry="12" fill="url(#glowR)"/>
          <ellipse cx="380" cy="32" rx="8" ry="12" fill="url(#glowG)"/>
          <ellipse cx="460" cy="18" rx="8" ry="12" fill="url(#glowY)"/>
          <ellipse cx="540" cy="30" rx="8" ry="12" fill="url(#glowR)"/>
        </g>
      </svg>
      <span class="tagline">Holiday Edition ‚ùÑÔ∏è</span>
    </div>

    <div class="brand">
      <!-- Logo removed by request -->
      <h1>Build Your Funky Bingo Card <span class="holly">üéÑ‚ú®</span></h1>
    </div>

    <p class="muted">Pick <strong>exactly 25 numbers</strong> from 1‚Äì100. Preview updates live. Then submit ‚Äî we‚Äôll log it to the sheet and send you to the Game Room.</p>

    <div class="two-col">
      <section>
        <div class="bar">
          <button id="randBtn" class="btn" type="button">üéÅ Random 25</button>
          <button id="clearBtn" class="btn" type="button">üßπ Clear</button>
          <span id="count" class="pill" aria-live="polite">Selected: 0 / 25</span>
          <span id="alert" class="muted warn" role="alert" aria-live="assertive"></span>
        </div>
        <div id="pad" class="pad" role="grid" aria-label="Pick numbers 1 to 100"></div>
      </section>

      <section>
        <h2>Card Preview</h2>
        <table class="grid" aria-label="5 by 5 card preview">
          <thead>
            <tr><th scope="col">B</th><th scope="col">I</th><th scope="col">N</th><th scope="col">G</th><th scope="col">O</th></tr>
          </thead>
          <tbody id="previewTop"></tbody>
        </table>
      </section>
    </div>

    <div class="section">
      <h2>Submit Your Card <span class="badge">Good Luck &amp; Good Cheer üéÖüèΩ</span></h2>

      <form id="bzForm" method="POST" autocomplete="on" novalidate>
        <label for="f_name">Name</label>
        <input id="f_name" name="name" placeholder="Your name" required autocomplete="name">

        <label for="f_email">Email</label>
        <input id="f_email" name="email" type="email" placeholder="you@example.com" required autocomplete="email">

        <label class="optin" for="f_notify" style="display:flex;gap:8px;align-items:flex-start;margin:6px 0 4px;">
          <input type="checkbox" id="f_notify" checked>
          <span>Send me reminders before future games.</span>
        </label>

        <label for="f_game_time">Which game?</label>
        <select id="f_game_time" name="game_time">
          <option value="">Decide later</option>
          <option value="20:00">First game (8:00 PM)</option>
          <option value="21:15">Second game (9:15 PM)</option>
        </select>

        <label for="f_tiktok">TikTok username</label>
        <input id="f_tiktok" name="tiktok" placeholder="@yourusername" autocomplete="username">

        <div class="remember-row">
          <input id="f_remember" type="checkbox" aria-label="Keep me on this device, baby">
          <label for="f_remember" style="margin:0;">Keep me on this device, baby</label>
          <span id="forget_link" class="forget-link" role="button" tabindex="0">Nah, forget me here</span>
        </div>

        <!-- üéÑ Softer, cleaner ‚ÄúSave your card‚Äù area -->
        <div class="save-strip">
          <input id="f_locked" type="checkbox">
          <label for="f_locked">Save your card on this device</label>
        </div>

        <label for="f_game_lock">Game Lock #</label>
        <input id="f_game_lock" name="game_lock" inputmode="numeric" placeholder="e.g., 7421" aria-describedby="lockHelp">
        <span id="lockHelp" class="muted">Digits only.</span>

        <!-- HIDDEN payloads -->
        <input type="hidden" id="f_selected_hidden" name="selected_numbers">
        <input type="hidden" id="f_json_hidden" name="grid_json">
        <input type="hidden" id="f_locked_hidden" name="locked" value="false">

        <!-- Server mirrors -->
        <input type="hidden" id="f_card_id" name="card_id">
        <input type="hidden" id="f_notify_h" name="notify">
        <input type="hidden" id="f_game_time_h" name="game_time_iso">

        <!-- Email-friendly rows -->
        <input type="hidden" id="f_row1" name="row_1">
        <input type="hidden" id="f_row2" name="row_2">
        <input type="hidden" id="f_row3" name="row_3">
        <input type="hidden" id="f_row4" name="row_4">
        <input type="hidden" id="f_row5" name="row_5">

        <!-- Optional BINGO columns -->
        <input type="hidden" id="f_colB" name="col_B">
        <input type="hidden" id="f_colI" name="col_I">
        <input type="hidden" id="f_colN" name="col_N">
        <input type="hidden" id="f_colG" name="col_G">
        <input type="hidden" id="f_colO" name="col_O">

        <table class="mini" aria-label="5 by 5 card preview (form)">
          <thead>
            <tr><th scope="col">B</th><th scope="col">I</th><th scope="col">N</th><th scope="col">G</th><th scope="col">O</th></tr>
          </thead>
          <tbody id="previewBottom"></tbody>
        </table>

        <div class="footer">
          <button class="btn" type="submit">Send &amp; Continue ‚ûú</button>
          <button id="saveBtn" class="btn" type="button">üíæ Save for Later</button>
          <button id="loadBtn" class="btn" type="button">üì• Load Saved</button>
          <button id="linkBtn" class="btn" type="button">üîó Copy Magic Link</button>
          <span id="msg" class="muted" aria-live="polite"></span>
        </div>

        <p class="muted" style="margin-top:6px;">
          By sendin‚Äô your card, you‚Äôre steppin‚Äô into the Funky Bingo fam‚Äîwhere the blues stay loud, the games stay live, and the good times roll. Unsubscribe anytime.
        </p>
      </form>

      <p class="muted">After submit, you‚Äôll be redirected to the Game Room.</p>
      <div class="holiday-footer"><span>‚ùÑÔ∏è From our juke joint to yours ‚Äî happy holidays and lucky numbers.</span></div>
    </div>
  </div>
</div>

<script>
(function(){
  // üëâ Bandzoogle game room URL
  const GAME_ROOM_URL = 'https://alabamabluesman.com/live-bingo-game-room';
  const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxvAlRjAj3f11KIGzwOMhxud-PGrMhsw5PWKEPIqKylj8PQp0ZBpxBPFUAD2Ktx_i0/exec';

  const sanitize = s => String(s||'').replace(/[<>"'`]/g,'');
  function normalizeHandle(s){ s=String(s||'').trim(); if(!s) return ''; return s.startsWith('@')?s:'@'+s.replace(/^@+/, '') }
  function toISOForTodayLocal(hhmm){
    if(!hhmm) return ''; const [hh,mm]=hhmm.split(':').map(Number);
    const now=new Date(); const d=new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0);
    const pad=n=>String(n).padStart(2,'0'); const off=-d.getTimezoneOffset();
    const sign=off>=0?'+':'-'; const tzH=pad(Math.floor(Math.abs(off)/60)); const tzM=pad(Math.abs(off)%60);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(hh)}:${pad(mm)}:00${sign}${tzH}:${tzM}`;
  }
  function isoToHHMM(iso){ if(!iso) return ''; const d=new Date(iso), pad=n=>String(n).padStart(2,'0'); return `${pad(d.getHours())}:${pad(d.getMinutes())}` }
  function b64urlEncode(str){ return btoa(unescape(encodeURIComponent(str))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'') }
  function b64urlDecode(str){ str=str.replace(/-/g,'+').replace(/_/g,'/'); const pad=str.length%4?4-(str.length%4):0; return decodeURIComponent(escape(atob(str+'='.repeat(pad)))) }

  const padEl = document.getElementById('pad');
  const previewTop = document.getElementById('previewTop');
  const previewBottom = document.getElementById('previewBottom');
  const alertEl = document.getElementById('alert');
  const msgEl = document.getElementById('msg');

  const form = document.getElementById('bzForm');
  const fName = document.getElementById('f_name');
  const fEmail = document.getElementById('f_email');
  const fTikTok = document.getElementById('f_tiktok');
  const fLocked = document.getElementById('f_locked');
  const fLockedHidden = document.getElementById('f_locked_hidden');
  const fGameLock = document.getElementById('f_game_lock');
  const fSelectedHidden = document.getElementById('f_selected_hidden');
  const fJsonHidden = document.getElementById('f_json_hidden');

  const fRow1 = document.getElementById('f_row1');
  const fRow2 = document.getElementById('f_row2');
  const fRow3 = document.getElementById('f_row3');
  const fRow4 = document.getElementById('f_row4');
  const fRow5 = document.getElementById('f_row5');
  const fColB = document.getElementById('f_colB');
  const fColI = document.getElementById('f_colI');
  const fColN = document.getElementById('f_colN');
  const fColG = document.getElementById('fColG');
  const fColO = document.getElementById('f_colO');

  const fRemember = document.getElementById('f_remember');
  const forgetLink = document.getElementById('forget_link');
  const REM_KEY = 'bingo_player_v1';

  const fNotify = document.getElementById('f_notify');
  const fGameTime = document.getElementById('f_game_time');
  const fNotifyH = document.getElementById('f_notify_h');
  const fGameTimeH = document.getElementById('f_game_time_h');
  const fCardId = document.getElementById('f_card_id');

  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');
  const linkBtn = document.getElementById('linkBtn');

  const state = { picks:new Set(), grid:[] };

  // Prefill remembered
  try{
    const saved = JSON.parse(localStorage.getItem(REM_KEY) || '{}');
    if(saved && (saved.name||saved.email||saved.tiktok)){
      if(saved.name) fName.value=saved.name;
      if(saved.email) fEmail.value=saved.email;
      if(saved.tiktok) fTikTok.value=saved.tiktok;
      if(fRemember) fRemember.checked=true;
    }
  }catch(e){}

  // Build number pad 1..100 (buttons)
  for(let n=1;n<=100;n++){
    const b=document.createElement('button');
    b.type='button'; b.className='num'; b.textContent=n; b.dataset.n=n;
    b.setAttribute('aria-pressed','false'); b.setAttribute('role','gridcell');
    b.addEventListener('click',()=>togglePick(n,b));
    b.addEventListener('keydown',(e)=>{
      const idx=n-1,row=Math.floor(idx/10),col=idx%10; let target=n;
      if(e.key==='ArrowRight'&&col<9)target=n+1;
      else if(e.key==='ArrowLeft'&&col>0)target=n-1;
      else if(e.key==='ArrowDown'&&row<9)target=n+10;
      else if(e.key==='ArrowUp'&&row>0)target=n-10;
      if(target!==n){ padEl.querySelector(`.num[data-n="${target}"]`)?.focus(); e.preventDefault(); }
    });
    padEl.appendChild(b);
  }

  function togglePick(n,btn){
    alertEl.textContent='';
    if(state.picks.has(n)){ state.picks.delete(n); btn.classList.remove('sel'); btn.setAttribute('aria-pressed','false'); }
    else{
      if(state.picks.size>=25){ alertEl.textContent='Select exactly 25.'; return; }
      state.picks.add(n); btn.classList.add('sel'); btn.setAttribute('aria-pressed','true');
    }
    syncAll();
  }

  function buildGrid(){
    let arr=Array.from(state.picks).sort((a,b)=>a-b);
    while(arr.length<25) arr.push('');
    const g=[]; let k=0;
    for(let r=0;r<5;r++){ const row=[]; for(let c=0;c<5;c++){ row.push(arr[k++]); } g.push(row); }
    state.grid=g;
  }
  function render(tbody){
    tbody.innerHTML=''; const g=state.grid;
    for(let r=0;r<5;r++){ const tr=document.createElement('tr');
      for(let c=0;c<5;c++){ const td=document.createElement('td'); td.textContent=g[r][c]; tr.appendChild(td); }
      tbody.appendChild(tr);
    }
  }
  function rowsAndCols(g){
    const rows=g.map(r=>r.map(x=>x===''?'':String(x)).join(' '));
    const cols=[0,1,2,3,4].map(c=>g.map(r=>r[c]).map(x=>x===''?'':String(x)).join(' '));
    return {rows,cols};
  }

  function newCardId(){ return (crypto.randomUUID? crypto.randomUUID():('cid_'+Date.now()+'_'+Math.random().toString(16).slice(2))); }
  if(!fCardId.value) fCardId.value=newCardId();

  function syncMetaFields(){
    if (fNotifyH) fNotifyH.value = (fNotify && fNotify.checked) ? 'true' : 'false';
    if (fGameTimeH) fGameTimeH.value = toISOForTodayLocal(fGameTime?.value || '');
  }

  function payload(){
    syncMetaFields();
    return {
      page:'builder', type:'number-bingo-1-100',
      selected:Array.from(state.picks).sort((a,b)=>a-b),
      grid:state.grid,
      user:{
        name:sanitize(fName.value.trim()),
        email:sanitize(fEmail.value.trim()),
        tiktok:sanitize(normalizeHandle(fTikTok.value.trim()))
      },
      locked:fLocked.checked,
      game_lock:fGameLock.value.trim().replace(/\D+/g,'').slice(0,8),
      card_id:fCardId.value,
      notify:(fNotify && fNotify.checked) ? true:false,
      game_time:fGameTimeH.value,
      timestamp:Date.now(),
      submitted_at:new Date().toISOString(),
      ua:navigator.userAgent,
      version:'2025-11-02-holiday-funky'
    };
  }

  function pushIntoForm(){
    const pl=payload();
    if(fCardId) fCardId.value=pl.card_id;
    if(fNotifyH) fNotifyH.value=pl.notify?'true':'false';
    if(fGameTimeH) fGameTimeH.value=pl.game_time||'';
    fSelectedHidden.value=pl.selected.join(', ');
    fJsonHidden.value=JSON.stringify(pl,null,2);
    fLockedHidden.value=pl.locked?'true':'false';
    const {rows,cols}=rowsAndCols(pl.grid);
    fRow1.value=rows[0]; fRow2.value=rows[1]; fRow3.value=rows[2]; fRow4.value=rows[3]; fRow5.value=rows[4];
    fColB.value=cols[0]; fColI.value=cols[1]; fColN.value=cols[2]; fColG.value=cols[3]; fColO.value=cols[4];
    try{ localStorage.setItem('bingo_card_last', JSON.stringify(pl)); }catch(e){}
  }

  function syncAll(){
    document.getElementById('count').textContent=`Selected: ${state.picks.size} / 25`;
    buildGrid(); render(previewTop); render(previewBottom); pushIntoForm();
  }

  function buildFlatPayload(pl){
    const {rows,cols}=rowsAndCols(pl.grid);
    return {
      name:pl.user.name, email:pl.user.email, tiktok:pl.user.tiktok,
      card_id:pl.card_id, notify:pl.notify?'true':'false', game_time_iso:pl.game_time,
      selected_numbers:pl.selected.join(', '), grid_json:JSON.stringify(pl),
      locked:pl.locked?'true':'false', game_lock:pl.game_lock,
      page:pl.page, type:pl.type, timestamp:String(pl.timestamp), submitted_at:pl.submitted_at, ua:pl.ua,
      row_1:rows[0], row_2:rows[1], row_3:rows[2], row_4:rows[3], row_5:rows[4],
      col_B:cols[0], col_I:cols[1], col_N:cols[2], col_G:cols[3], col_O:cols[4],
    };
  }

  function celebrateConfetti(bursts=1){
    const layer=document.getElementById('confetti-layer')||(()=>{const d=document.createElement('div');d.id='confetti-layer';document.body.appendChild(d);return d})();
    const colors=['#F87171','#FBBF24','#34D399','#60A5FA','#A78BFA','#F472B6','#FDE68A','#22D3EE']; const W=window.innerWidth;
    for(let b=0;b<bursts;b++){ const frag=document.createDocumentFragment();
      for(let i=0;i<120;i++){ const el=document.createElement('div'); el.className='confetti';
        const size=8+Math.random()*8; el.style.width=size+'px'; el.style.height=(size*1.35)+'px';
        el.style.background = Math.random()<0.25 ? `linear-gradient(180deg, ${colors[i%colors.length]}, #fff)` : colors[(i+Math.floor(Math.random()*colors.length))%colors.length];
        const startX=(Math.random()*W)+'px'; el.style.setProperty('--x',startX); el.style.setProperty('--dx',(Math.random()*160-80)+'px'); el.style.setProperty('--dur',(700+Math.random()*900)+'ms');
        el.style.left=0; el.style.transform=`translate3d(${startX},-10%,0)`; el.addEventListener('animationend',()=>el.remove()); frag.appendChild(el);
      } layer.appendChild(frag);
    }
  }

  function postToGoogle(pl){
    const flat = buildFlatPayload(pl);
    try{
      const tmpForm=document.createElement('form');
      tmpForm.style.display='none';
      tmpForm.method='POST';
      tmpForm.action=GOOGLE_SCRIPT_URL;
      tmpForm.target='silent_post_iframe';
      for(const [k,v] of Object.entries(flat)){
        const input=document.createElement('input');
        input.type='hidden'; input.name=k; input.value=v; tmpForm.appendChild(input);
      }
      document.body.appendChild(tmpForm);
      tmpForm.submit();
      setTimeout(()=>tmpForm.remove(),1500);
      return Promise.resolve(true);
    }catch(_){ return Promise.resolve(true); }
  }

  document.getElementById('randBtn').addEventListener('click', ()=>{
    state.picks.clear(); padEl.querySelectorAll('.num.sel').forEach(el=>{el.classList.remove('sel'); el.setAttribute('aria-pressed','false')});
    const pool=[...Array(100)].map((_,i)=>i+1);
    for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
    pool.slice(0,25).forEach(n=>{ state.picks.add(n); const cell=padEl.querySelector(`.num[data-n="${n}"]`); if(cell){ cell.classList.add('sel'); cell.setAttribute('aria-pressed','true'); }});
    syncAll(); const first=Array.from(state.picks).sort((a,b)=>a-b)[0]; padEl.querySelector(`.num[data-n="${first}"]`)?.focus();
  });
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    state.picks.clear(); padEl.querySelectorAll('.num.sel').forEach(el=>{el.classList.remove('sel'); el.setAttribute('aria-pressed','false')}); syncAll();
  });

  ['input','change'].forEach(evt=>{
    fName.addEventListener(evt,pushIntoForm);
    fEmail.addEventListener(evt,pushIntoForm);
    fTikTok.addEventListener(evt,()=>{ fTikTok.value=normalizeHandle(fTikTok.value); pushIntoForm(); });
    fLocked.addEventListener(evt,pushIntoForm);
    fGameLock.addEventListener(evt,()=>{ fGameLock.value=fGameLock.value.replace(/\D+/g,'').slice(0,8); pushIntoForm(); });
    if(fNotify) fNotify.addEventListener(evt,()=>{ syncMetaFields(); pushIntoForm(); });
    if(fGameTime) fGameTime.addEventListener(evt,()=>{ syncMetaFields(); pushIntoForm(); });
  });

  function saveRemembered(){
    if(!fRemember || !fRemember.checked) return;
    const data={ name:fName.value.trim(), email:fEmail.value.trim(), tiktok:normalizeHandle(fTikTok.value.trim()) };
    try{ localStorage.setItem(REM_KEY, JSON.stringify(data)); }catch(e){}
  }
  if(fRemember){
    [fName,fEmail,fTikTok].forEach(el=>{ el.addEventListener('input',saveRemembered); el.addEventListener('change',saveRemembered); });
    fRemember.addEventListener('change', ()=>{ if(!fRemember.checked) localStorage.removeItem(REM_KEY); else saveRemembered(); });
  }
  if(forgetLink){
    const clearSaved=()=>{ localStorage.removeItem(REM_KEY); if(fRemember) fRemember.checked=false; alert('All right‚Äîinfo cleared on this device.') };
    forgetLink.addEventListener('click', e=>{ e.preventDefault(); clearSaved(); });
    forgetLink.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); clearSaved(); }});
  }

  const SAVE_KEY='bingo_card_saved_v2';
  function saveCurrentCardLocal(){
    if(state.picks.size!==25){ alert('Pick exactly 25 numbers first, sugar.'); return; }
    const pl=payload();
    const pack={ picks:pl.selected, user:pl.user, locked:pl.locked, game_lock:pl.game_lock, card_id:pl.card_id, game_time:pl.game_time, notify:pl.notify, saved_at:Date.now(), v:'v2' };
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(pack)); alert('Card saved on this device. Hit ‚ÄúLoad Saved‚Äù later.'); }catch(e){ alert('Couldn‚Äôt save on this device.'); }
  }
  function loadSavedCardLocal(){
    try{
      const raw=localStorage.getItem(SAVE_KEY); if(!raw) return alert('No saved card on this device yet.');
      const pack=JSON.parse(raw);
      state.picks.clear(); padEl.querySelectorAll('.num.sel').forEach(el=>{el.classList.remove('sel'); el.setAttribute('aria-pressed','false')});
      (pack.picks||[]).forEach(n=>{ state.picks.add(Number(n)); const cell=padEl.querySelector(`.num[data-n="${n}"]`); if(cell){ cell.classList.add('sel'); cell.setAttribute('aria-pressed','true'); }});
      fName.value=pack.user?.name||''; fEmail.value=pack.user?.email||''; fTikTok.value=pack.user?.tiktok||'';
      fLocked.checked=!!pack.locked; fGameLock.value=pack.game_lock||'';
      if(pack.card_id) fCardId.value=pack.card_id;
      if(pack.game_time){ fGameTimeH.value=pack.game_time; const hhmm=isoToHHMM(pack.game_time); if(hhmm) fGameTime.value=hhmm; }
      if(typeof pack.notify==='boolean') fNotify.checked=pack.notify;
      syncAll(); alert('Loaded your saved card. Ready to roll.');
    }catch(e){ alert('Couldn‚Äôt load the saved card.'); }
  }
  saveBtn?.addEventListener('click', saveCurrentCardLocal);
  loadBtn?.addEventListener('click', loadSavedCardLocal);

  function buildMagicLink(){
    if(state.picks.size!==25){ alert('Pick exactly 25 numbers first.'); return null; }
    const pl=payload();
    const minimal={ p:pl.selected, u:pl.user, l:pl.locked, g:pl.game_lock, id:pl.card_id, n:pl.notify };
    const hash=b64urlEncode(JSON.stringify(minimal));
    return `${location.origin}${location.pathname}#card=${hash}`;
  }
  function applyFromHash(){
    const m=location.hash.match(/#card=([^&]+)/); if(!m) return;
    try{
      const decoded=JSON.parse(b64urlDecode(m[1]));
      state.picks.clear(); padEl.querySelectorAll('.num.sel').forEach(el=>{el.classList.remove('sel'); el.setAttribute('aria-pressed','false')});
      (decoded.p||[]).forEach(n=>{ state.picks.add(Number(n)); const cell=padEl.querySelector(`.num[data-n="${n}"]`); if(cell){ cell.classList.add('sel'); cell.setAttribute('aria-pressed','true'); }});
      fName.value=decoded.u?.name||''; fEmail.value=decoded.u?.email||''; fTikTok.value=decoded.u?.tiktok||'';
      fLocked.checked=!!decoded.l; fGameLock.value=decoded.g||''; if(decoded.id) fCardId.value=decoded.id;
      if(typeof decoded.n==='boolean') fNotify.checked=decoded.n;
      syncAll(); history.replaceState(null,'',location.pathname+location.search); alert('Loaded your card from magic link.');
    }catch(_){}
  }
  linkBtn?.addEventListener('click', ()=>{
    const link=buildMagicLink(); if(!link) return;
    (navigator.clipboard?.writeText(link) || Promise.reject()).then(()=>alert('Magic link copied. Bookmark or DM it to yourself.'),()=>prompt('Copy your magic link:', link));
  });
  applyFromHash();

  (function promptLoad(){
    if(!localStorage.getItem(SAVE_KEY)) return;
    setTimeout(()=>{ if(confirm('We found a saved card on this device. Load it now?')) loadSavedCardLocal(); }, 400);
  })();

  // üö® SUBMIT HANDLER
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    if(!fName.value.trim() || !fEmail.value.trim()){
      alertEl.textContent='Name and email are required.';
      return;
    }
    if(state.picks.size!==25){
      alertEl.textContent='Please select exactly 25 numbers before submitting.';
      return;
    }

    pushIntoForm();
    const submitBtn=form.querySelector('button[type="submit"]');
    [submitBtn, saveBtn, loadBtn, linkBtn].forEach(b=>b?.setAttribute('disabled',''));
    msgEl.textContent='Sending‚Ä¶';

    const pl=payload();

    try{
      localStorage.setItem('bingo_notify_optin', pl.notify?'yes':'no');
      localStorage.setItem('last_submit_card_id', pl.card_id);
    }catch(e){}

    await postToGoogle(pl);

    if(pl.notify) msgEl.textContent='We‚Äôll remind you before future games. ‚úì';
    celebrateConfetti(1);

    // üëâ pack minimal card info for Bandzoogle + iframe
    const minimal = {
      grid:   pl.grid,
      user:   pl.user,
      card_id: pl.card_id
    };

    let packed = '';
    try{
      packed = b64urlEncode(JSON.stringify(minimal));
    }catch(_){}

    setTimeout(()=>{
      let url = GAME_ROOM_URL + '?card=' + encodeURIComponent(pl.card_id);
      if (packed){
        url += '&packed=' + encodeURIComponent(packed);
      }
      window.location.href = url;
    }, 900);
  });

  // init
  syncAll();
})();
</script>
</body>
</html>
