<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Fat Mule â€” Game Room</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg1:#061a1a; --bg2:#0b2a2a; --ring:rgba(45,212,191,.5);
    --panel:rgba(6,18,20,.72); --border:rgba(255,255,255,.10);
    --muted:#b6c2d1; --ink:#e6f6ff; --head:#e2e8f0; --accent:#16a34a;
  }
  html,body{height:100%}
  body{
    margin:0;color:#f8fafc;font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    background:
      radial-gradient(1200px 800px at 10% -10%, #103, transparent 60%),
      radial-gradient(1000px 700px at 90% -20%, #013, transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  .panel{
    background:var(--panel); backdrop-filter:blur(6px);
    border:1px solid var(--border); border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    padding:18px
  }
  .brand{display:flex;align-items:center;gap:12px;margin:6px 0 12px}
  .brand img{height:52px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
  h1{margin:0;font-size:26px}
  .tag{font-size:12px;color:#cbd5e1}

  /* two columns: stream (left) / card (right) */
  .two{display:grid;grid-template-columns:1.2fr .8fr;gap:20px}
  @media (max-width:980px){.two{grid-template-columns:1fr}}

  /* tiktok block */
  .live{
    border:1px solid var(--border); border-radius:12px; overflow:hidden;
    background:rgba(0,0,0,.35); padding:10px;
  }
  .live .fallback{padding:14px;font-size:14px;color:#e2e8f0}

  /* card */
  .grid{border-collapse:separate;border-spacing:0;width:100%;max-width:460px;overflow:hidden;border-radius:12px;
        box-shadow:0 10px 24px rgba(0,0,0,.35)}
  .grid th{background:linear-gradient(180deg,#134e4a,#0b2a2a);color:#eafff8;padding:10px;border-bottom:1px solid rgba(255,255,255,.12)}
  .grid td{background:rgba(255,255,255,.06);color:var(--ink);font-weight:800;padding:12px;border:1px solid rgba(255,255,255,.06);text-align:center;cursor:pointer;user-select:none}
  .grid td.cell{position:relative}
  .grid td.cell.hit{background:rgba(22,163,74,.12)}
  .grid td.cell.hit::after{
    content:''; position:absolute; inset:4px; border:3px solid var(--accent); border-radius:10px;
    box-shadow:0 0 0 3px rgba(22,163,74,.25) inset;
    pointer-events:none;
  }
  .btn{
    background:linear-gradient(180deg,#0f172a,#0b1220); color:#fff;border:1px solid #203041;border-radius:10px;
    padding:10px 16px;cursor:pointer;font-weight:800;letter-spacing:.2px;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 6px 14px rgba(0,0,0,.25)
  }
  .btn:focus-visible{outline:0;box-shadow:0 0 0 3px var(--ring), 0 0 0 1px #0e7a3a inset}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .pill{display:inline-block;padding:6px 10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;background:rgba(255,255,255,.1);font-weight:800}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>

<!-- Hidden iframe for no-CORS posts -->
<iframe name="silent_post_iframe" style="display:none;width:0;height:0;border:0" aria-hidden="true"></iframe>

<div class="wrap">
  <div class="panel">
    <div class="brand">
      <img src="./assets/fat-mule-records-logo.png" alt="Fat Mule Records logo">
      <div>
        <h1>Fat Mule Game Room</h1>
        <div class="tag">Stream on the left, your luck on the right. ðŸŽ„ Tap numbers to mark â€™em.</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <span id="cardTag" class="pill">Card: â€”</span>
      <span id="playerTag" class="pill">@â€”</span>
      <span id="statusTag" class="tag"></span>
    </div>

    <div class="two">
      <!-- LEFT: TikTok Creator embed -->
      <section>
        <div class="live">
          <blockquote class="tiktok-embed"
            cite="https://www.tiktok.com/@ricpatton"
            data-unique-id="ricpatton"
            data-embed-type="creator"
            style="max-width: 100%; min-width: 280px;">
            <section>
              <a target="_blank" href="https://www.tiktok.com/@ricpatton?refer=creator_embed">@ricpatton</a>
            </section>
          </blockquote>
          <script async src="https://www.tiktok.com/embed.js"></script>
          <div id="liveFallback" class="fallback" style="display:none">
            If the live doesnâ€™t load, refresh or check TikTok embed permissions.
          </div>
        </div>
      </section>

      <!-- RIGHT: Card + action -->
      <section>
        <h3 style="margin:0 0 8px;color:var(--head)">Your Card</h3>
        <table class="grid" aria-label="Your 5Ã—5 card">
          <thead><tr><th>B</th><th>I</th><th>N</th><th>G</th><th>O</th></tr></thead>
          <tbody id="cardBody"></tbody>
        </table>
        <p class="muted" id="cardNote" style="margin-top:8px"></p>

        <div class="btn-row">
          <button id="bingoBtn" class="btn" type="button">ðŸŽ‰ I Got Bingo</button>
          <button id="clearMarksBtn" class="btn" type="button" title="Clear all marks">ðŸ§¹ Clear Marks</button>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
(function(){
  // === CONFIG ===
  const GOOGLE_SCRIPT_URL =
    'https://script.google.com/macros/s/AKfycbxvAlRjAj3f11KIGzwOMhxud-PGrMhsw5PWKEPIqKylj8PQp0ZBpxBPFUAD2Ktx_i0/exec';

  // === Context (card + player) ===
  const qs = new URLSearchParams(location.search);
  const cardId = qs.get('card') || '';

  let last = {};
  try{ last = JSON.parse(localStorage.getItem('bingo_card_last')||'{}'); }catch(_){}
  const user = last.user || {};
  const tikTok = user.tiktok || '@unknown';
  const grid = Array.isArray(last.grid) ? last.grid : [];

  // === Called/marked storage per card ===
  const CALLED_KEY = (id)=> `bingo_called_${id||'anon'}`;
  function loadCalled(){
    try{ const arr = JSON.parse(localStorage.getItem(CALLED_KEY(cardId))||'[]'); return new Set(arr.map(x=>String(Number(x)))) }catch(_){ return new Set() }
  }
  function saveCalled(set){
    try{ localStorage.setItem(CALLED_KEY(cardId), JSON.stringify(Array.from(set))) }catch(_){}
  }
  let calledSet = loadCalled();

  // === UI refs ===
  const cardTag   = document.getElementById('cardTag');
  const playerTag = document.getElementById('playerTag');
  const statusTag = document.getElementById('statusTag');
  const cardBody  = document.getElementById('cardBody');
  const cardNote  = document.getElementById('cardNote');
  const bingoBtn  = document.getElementById('bingoBtn');
  const clearBtn  = document.getElementById('clearMarksBtn');

  // Fallback if TikTok embed script errors
  window.addEventListener('error', (e)=>{
    if (String(e?.target?.src||'').includes('tiktok.com/embed.js')){
      const fb=document.getElementById('liveFallback'); if(fb) fb.style.display='block';
    }
  }, true);

  // === Render + interactivity ===
  function renderCard(g){
    const g5 = (Array.isArray(g) && g.length===5 && g.every(r=>Array.isArray(r)&&r.length===5))
      ? g
      : Array.from({length:5},()=>Array(5).fill(''));

    cardBody.innerHTML = '';
    for(let r=0;r<5;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        td.className = 'cell';
        const num = String(g5[r][c] ?? '');
        td.textContent = num;
        td.dataset.num = num;

        // apply current mark
        if (num && calledSet.has(String(Number(num)))) td.classList.add('hit');

        // toggle on click
        td.addEventListener('click', ()=>{
          if (!num) return;
          const key = String(Number(num));
          if (calledSet.has(key)){ calledSet.delete(key); td.classList.remove('hit'); }
          else { calledSet.add(key); td.classList.add('hit'); }
          saveCalled(calledSet);
        });

        tr.appendChild(td);
      }
      cardBody.appendChild(tr);
    }
  }

  // === Make compact JPEG with hits drawn ===
  function makeCardJPEG({ grid = [], title = 'Fat Mule Bingo', cardId = '', tiktok = '@unknown', called = [] } = {}){
    const SCALE = 0.66;
    const W = Math.floor(1000*SCALE), H = Math.floor(1200*SCALE);
    const P = Math.floor(40*SCALE);
    const COLS=5, ROWS=5, cell=Math.floor((W-P*2)/COLS), top=P+Math.floor(120*SCALE);

    const cvs=document.createElement('canvas'); cvs.width=W; cvs.height=H;
    const ctx=cvs.getContext('2d');

    ctx.fillStyle='#0b2a2a'; ctx.fillRect(0,0,W,H);
    const g=ctx.createLinearGradient(0,0,0,Math.floor(200*SCALE));
    g.addColorStop(0,'#134e4a'); g.addColorStop(1,'#0b2a2a');
    ctx.fillStyle=g; ctx.fillRect(P,P,W-P*2,Math.floor(110*SCALE));

    ctx.fillStyle='#eafff8';
    ctx.font=`bold ${Math.floor(40*SCALE)}px system-ui,Segoe UI,Arial`;
    ctx.fillText(title, P+Math.floor(12*SCALE), P+Math.floor(52*SCALE));
    ctx.font=`700 ${Math.floor(24*SCALE)}px system-ui,Segoe UI,Arial`;
    ctx.fillText(`TikTok: ${tiktok}`, P+Math.floor(12*SCALE), P+Math.floor(86*SCALE));

    ctx.fillStyle='#a7f3d0';
    ctx.font=`600 ${Math.floor(20*SCALE)}px system-ui,Segoe UI,Arial`;
    ctx.fillText(`Card ID: ${cardId||'â€”'}`, W-P-Math.floor(340*SCALE), P+Math.floor(52*SCALE));
    ctx.fillText(new Date().toLocaleString(), W-P-Math.floor(340*SCALE), P+Math.floor(86*SCALE));

    ctx.fillStyle='#eafff8'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`900 ${Math.floor(36*SCALE)}px system-ui,Segoe UI,Arial`;
    'BINGO'.split('').forEach((ch,i)=>ctx.fillText(ch, P+i*cell+cell/2, top-Math.floor(28*SCALE)));

    const g5=(Array.isArray(grid)&&grid.length===5&&grid.every(r=>Array.isArray(r)&&r.length===5))
      ? grid : Array.from({length:5},()=>Array(5).fill(''));
    const calledSetLocal = new Set((called||[]).map(n=>String(Number(n))));

    ctx.strokeStyle='rgba(255,255,255,.2)'; ctx.lineWidth=2;
    ctx.fillStyle='rgba(255,255,255,.06)';
    ctx.font=`800 ${Math.floor(34*SCALE)}px system-ui,Segoe UI,Arial`;
    ctx.fillStyle='#e6f6ff';

    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const x=P+c*cell, y=top+r*cell;
        ctx.fillRect(x,y,cell,cell); ctx.strokeRect(x,y,cell,cell);
        const n = String(g5[r][c] ?? '');
        ctx.fillText(n, x+cell/2, y+cell/2);

        if (n && calledSetLocal.has(String(Number(n)))){
          // green highlight ring
          ctx.save();
          ctx.strokeStyle='#16a34a';
          ctx.lineWidth=4;
          ctx.strokeRect(x+4, y+4, cell-8, cell-8);
          ctx.strokeStyle='rgba(22,163,74,.28)';
          ctx.lineWidth=8;
          ctx.strokeRect(x+8, y+8, cell-16, cell-16);
          ctx.restore();
        }
      }
    }

    return cvs.toDataURL('image/jpeg', 0.68); // compact + clear
  }

  // === Hidden-iframe post ===
  function post(fields){
    try{
      const f=document.createElement('form');
      f.style.display='none';
      f.method='POST';
      f.action=GOOGLE_SCRIPT_URL;
      f.target='silent_post_iframe';
      for(const [k,v] of Object.entries(fields)){
        const i=document.createElement('input');
        i.type='hidden'; i.name=k; i.value=String(v ?? '');
        f.appendChild(i);
      }
      document.body.appendChild(f);
      f.submit();
      setTimeout(()=>f.remove(), 1200);
    }catch(_){}
  }

  // === Init UI ===
  cardTag.textContent   = 'Card: ' + (cardId || 'â€”');
  playerTag.textContent = tikTok || '@â€”';
  statusTag.textContent = cardId ? 'Loaded from ?card=' : 'No Card ID in URL';
  statusTag.className   = 'tag ' + (cardId ? 'ok' : 'bad');
  renderCard(grid);
  cardNote.textContent  = grid?.length ? 'Tap numbers to mark called ones.' : 'No grid found on this device. You can still call Bingo with Card ID.';

  // Clear all marks (for this card)
  clearBtn?.addEventListener('click', ()=>{
    calledSet = new Set();
    saveCalled(calledSet);
    renderCard(grid);
  });

  // === Bingo action (sends JPEG with your current marks) ===
  bingoBtn?.addEventListener('click', ()=>{
    if (!cardId){ alert('No Card ID found. Re-enter from your builder link.'); return; }
    const pattern = prompt('What pattern did you hit? (e.g., Row 3, Diagonal, Blackout)') || '';

    const calledArr = Array.from(calledSet);
    const jpg = makeCardJPEG({
      grid,
      title:'Fat Mule Bingo â€” Bingo Proof',
      cardId,
      tiktok: tikTok,
      called: calledArr
    });
    const b64 = (jpg.split(',')[1] || '');

    post({
      event:'bingo',
      page:'gameroom',
      card_id: cardId,
      name: '', email: '',
      pattern,
      ua: navigator.userAgent,
      card_jpg_b64: b64
    });

    alert('Bingo called! Logged with proof.');
  });
})();
</script>
</body>
</html>
