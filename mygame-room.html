<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Fat Mule â€” Game Room (Card Only)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<style>
  :root{
    --bg1:#061a1a; --bg2:#0b2a2a; --ring:rgba(45,212,191,.5);
    --panel:rgba(6,18,20,.72); --border:rgba(255,255,255,.10);
    --muted:#b6c2d1; --ink:#e6f6ff; --head:#e2e8f0; --accent:#16a34a; --bad:#ef4444;
  }
  html,body{height:100%}
  body{
    margin:0;color:#f8fafc;font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
    background:
      radial-gradient(1200px 800px at 10% -10%, #103, transparent 60%),
      radial-gradient(1000px 700px at 90% -20%, #013, transparent 60%),
      linear-gradient(180deg,var(--bg1),var(--bg2));
  }
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  .panel{
    background:var(--panel); backdrop-filter:blur(6px);
    border:1px solid var(--border); border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    padding:18px
  }
  .brand{display:flex;align-items:center;gap:12px;margin:6px 0 12px;flex-wrap:wrap}
  .brand img{height:52px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
  h1{margin:0;font-size:26px}
  .tag{font-size:12px;color:#cbd5e1}

  .one{display:block}

  .grid{
    border-collapse:separate;border-spacing:0;width:100%;max-width:460px;overflow:hidden;border-radius:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.35)
  }
  .grid th{
    background:linear-gradient(180deg,#134e4a,#0b2a2a);color:#eafff8;padding:10px;
    border-bottom:1px solid rgba(255,255,255,.12)
  }
  .grid td{
    background:rgba(255,255,255,.06);color:var(--ink);font-weight:800;
    padding:12px;border:1px solid rgba(255,255,255,.06);
    text-align:center;cursor:pointer;user-select:none
  }
  .grid td.cell{position:relative}
  .grid td.cell.hit{background:rgba(22,163,74,.12)}
  .grid td.cell.hit::after{
    content:''; position:absolute; inset:4px; border:3px solid var(--accent); border-radius:10px;
    box-shadow:0 0 0 3px rgba(22,163,74,.25) inset; pointer-events:none;
  }

  .btn{
    background:linear-gradient(180deg,#0f172a,#0b1220); color:#fff;border:1px solid #203041;border-radius:10px;
    padding:12px 18px;cursor:pointer;font-weight:800;letter-spacing:.2px;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.06), 0 6px 14px rgba(0,0,0,.25);
    transition:transform .06s, box-shadow .12s, background .2s, border-color .2s, opacity .2s;
  }
  .btn:active{ transform:scale(.98) }
  .btn:focus-visible{outline:0;box-shadow:0 0 0 3px var(--ring), 0 0 0 1px #0e7a3a inset}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  .pill{display:inline-block;padding:6px 10px;border:1px solid rgba(255,255,255,.18);border-radius:999px;background:rgba(255,255,255,.1);font-weight:800}
  .muted{color:var(--muted);font-size:12px}

  #bingoBtn.ready{
    border-color:#126a33;
    animation:breathe 1.2s ease-in-out infinite;
    box-shadow:0 0 0 0 rgba(22,163,74,.35);
  }
  @keyframes breathe{
    0%{box-shadow:0 0 0 0 rgba(22,163,74,.35)}
    100%{box-shadow:0 0 0 12px rgba(22,163,74,0)}
  }
  #bingoBtn.busy{ opacity:.7; pointer-events:none; background:linear-gradient(180deg,#0b1220,#0b1220); }
  #bingoBtn.sent{ background:linear-gradient(180deg,#0e3a22,#0b2417); border-color:#22c55e; }
  #bingoBtn.sent::after{ content:' âœ“'; font-weight:900; color:#22c55e; }

  .flash{
    position:fixed; inset:0; background:rgba(34,197,94,.12);
    animation:flash .35s ease-out 1; pointer-events:none; z-index:9999; display:none;
  }
  .flash.show{ display:block; }
  @keyframes flash{ from{opacity:1} to{opacity:0} }
</style>
</head>
<body>

<iframe name="silent_post_iframe" style="display:none;width:0;height:0;border:0" aria-hidden="true"></iframe>

<div class="wrap">
  <div class="panel">
    <div class="brand">
      <img src="./assets/fat-mule-records-logo.png" alt="Fat Mule Records logo">
      <div>
        <h1>Fat Mule Game Room</h1>
        <div class="tag">Keep this page open to play your card. Tap numbers to mark â€™em.</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <span id="cardTag" class="pill">Card: â€”</span>
      <span id="playerTag" class="pill">@â€”</span>
      <span id="statusTag" class="tag"></span>
    </div>

    <div class="one">
      <section>
        <h3 style="margin:0 0 8px;color:var(--head)">Your Card</h3>
        <table class="grid" aria-label="Your 5Ã—5 card">
          <thead>
            <tr><th>B</th><th>I</th><th>N</th><th>G</th><th>O</th></tr>
          </thead>
          <tbody id="cardBody"></tbody>
        </table>
        <p class="muted" id="cardNote" style="margin-top:8px"></p>

        <div class="btn-row">
          <button id="bingoBtn" class="btn" type="button">ðŸŽ‰ I Got Bingo</button>
          <button id="clearMarksBtn" class="btn" type="button" title="Clear all marks">ðŸ§¹ Clear Marks</button>
        </div>
      </section>
    </div>
  </div>
</div>

<div id="flash" class="flash" aria-hidden="true"></div>

<script>
(function(){
  const GOOGLE_SCRIPT_URL =
    'https://script.google.com/macros/s/AKfycbxvAlRjAj3f11KIGzwOMhxud-PGrMhsw5PWKEPIqKylj8PQp0ZBpxBPFUAD2Ktx_i0/exec';

  const $ = (s)=>document.querySelector(s);

  function shortCardId(id){
    if (!id) return 'â€”';
    const s = String(id);
    if (s.length <= 6) return s;
    return 'â€¦' + s.slice(-4);
  }

  function b64urlDecode(str){
    try{
      str = String(str || '');
      if (!str) return '';
      str = str.replace(/-/g,'+').replace(/_/g,'/');
      const pad = str.length % 4 ? 4 - (str.length % 4) : 0;
      const base = str + '='.repeat(pad);
      return decodeURIComponent(escape(atob(base)));
    }catch(e){
      return '';
    }
  }

  const qs      = new URLSearchParams(location.search);
  let   cardId  = qs.get('card')   || '';
  const pattern = qs.get('pat')    || '';
  const packed  = qs.get('packed') || '';

  let last = {};

  if (packed){
    try{
      const decoded = JSON.parse(b64urlDecode(packed) || '{}');
      last = {
        grid: decoded.grid || [],
        user: decoded.user || {},
        card_id: decoded.card_id || cardId || ''
      };
      if (!cardId && last.card_id) cardId = last.card_id;
      try{ localStorage.setItem('bingo_card_last', JSON.stringify(last)); }catch(_){}
    }catch(e){
      try{ last = JSON.parse(localStorage.getItem('bingo_card_last')||'{}'); }catch(_){}
    }
  }else{
    try{ last = JSON.parse(localStorage.getItem('bingo_card_last')||'{}'); }catch(_){}
  }

  const user   = last.user || {};
  const tikTok = user.tiktok || '@unknown';
  const grid   = Array.isArray(last.grid) ? last.grid : [];
  if (!cardId && last.card_id) cardId = last.card_id || '';

  const CALLED_KEY = (id)=> `bingo_called_${id||'anon'}`;
  function loadCalled(){
    try{
      const arr = JSON.parse(localStorage.getItem(CALLED_KEY(cardId))||'[]');
      return new Set(arr.map(x=>String(Number(x))));
    }catch(_){ return new Set(); }
  }
  function saveCalled(set){
    try{ localStorage.setItem(CALLED_KEY(cardId), JSON.stringify(Array.from(set))); }catch(_){}
  }
  let calledSet = loadCalled();

  const cardTag   = $('#cardTag');
  const playerTag = $('#playerTag');
  const statusTag = $('#statusTag');
  const cardBody  = $('#cardBody');
  const cardNote  = $('#cardNote');
  const bingoBtn  = $('#bingoBtn');
  const clearBtn  = $('#clearMarksBtn');
  const flash     = $('#flash');

  cardTag.textContent   = 'Card: ' + (cardId ? shortCardId(cardId) : 'â€”');
  playerTag.textContent = tikTok || '@â€”';
  statusTag.textContent = pattern ? ('Pattern: ' + pattern) : '';

  function updateBingoReady(){
    if (calledSet.size > 0) bingoBtn.classList.add('ready');
    else bingoBtn.classList.remove('ready');
  }

  function renderCard(g){
    const g5 = (Array.isArray(g) && g.length===5 && g.every(r=>Array.isArray(r)&&r.length===5))
      ? g
      : Array.from({length:5},()=>Array(5).fill(''));

    cardBody.innerHTML = '';
    for(let r=0;r<5;r++){
      const tr=document.createElement('tr');
      for(let c=0;c<5;c++){
        const td=document.createElement('td');
        td.className = 'cell';
        const num = String(g5[r][c] ?? '');
        td.textContent = num;
        td.dataset.num = num;

        if (num && calledSet.has(String(Number(num)))) td.classList.add('hit');

        td.addEventListener('click', ()=>{
          if (!num) return;
          const key = String(Number(num));
          if (calledSet.has(key)){
            calledSet.delete(key);
            td.classList.remove('hit');
          }else{
            calledSet.add(key);
            td.classList.add('hit');
          }
          saveCalled(calledSet);
          updateBingoReady();
        });

        tr.appendChild(td);
      }
      cardBody.appendChild(tr);
    }
    updateBingoReady();
  }

  function makeCardJPEG({ grid = [], title = 'Fat Mule Bingo', cardId = '', tiktok = '@unknown', called = [] } = {}){
    const SCALE = 0.66;
    const W = Math.floor(1000*SCALE), H = Math.floor(1200*SCALE);
    const P = Math.floor(40*SCALE);
    const COLS=5, ROWS=5, cell=Math.floor((W-P*2)/COLS), top=P+Math.floor(120*SCALE);

    const CELL_BG    = 'rgba(255,255,255,.06)';
    const CELL_EDGE  = 'rgba(255,255,255,.20)';
    const TEXT_FILL  = '#e6f6ff';
    const TEXT_STROKE= 'rgba(0,0,0,.35)';

    const cvs=document.createElement('canvas'); cvs.width=W; cvs.height=H;
    const ctx=cvs.getContext('2d');

    ctx.fillStyle='#0b2a2a'; ctx.fillRect(0,0,W,H);
    const g=ctx.createLinearGradient(0,0,0,Math.floor(200*SCALE));
    g.addColorStop(0,'#134e4a'); g.addColorStop(1,'#0b2a2a');
    ctx.fillStyle=g; ctx.fillRect(P,P,W-P*2,Math.floor(110*SCALE));

    ctx.fillStyle='#eafff8';
    ctx.font=`bold ${Math.floor(40*SCALE)}px system-ui,Segoe UI,Arial`;
    ctx.fillText(title, P+Math.floor(12*SCALE), P+Math.floor(52*SCALE));
    ctx.font=`700 ${Math.floor(24*SCALE)}px system-ui,Segoe UI,Arial`;
    ctx.fillText(`TikTok: ${tiktok}`, P+Math.floor(12*SCALE), P+Math.floor(86*SCALE));

    ctx.fillStyle='#a7f3d0';
    ctx.font=`600 ${Math.floor(20*SCALE)}px system-ui,Segoe UI,Arial`;
    ctx.fillText(`Card ID: ${cardId||'â€”'}`, W-P-Math.floor(340*SCALE), P+Math.floor(52*SCALE));
    ctx.fillText(new Date().toLocaleString(), W-P-Math.floor(340*SCALE), P+Math.floor(86*SCALE));

    ctx.fillStyle='#eafff8'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`900 ${Math.floor(36*SCALE)}px system-ui,Segoe UI,Arial`;
    'BINGO'.split('').forEach((ch,i)=>ctx.fillText(ch, P+i*cell+cell/2, top-Math.floor(28*SCALE)));

    const g5=(Array.isArray(grid)&&grid.length===5&&grid.every(r=>Array.isArray(r)&&r.length===5))
      ? grid : Array.from({length:5},()=>Array(5).fill(''));
    const calledSetLocal = new Set((called||[]).map(n=>String(Number(n))));

    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`800 ${Math.floor(34*SCALE)}px system-ui,Segoe UI,Arial`;

    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const x=P+c*cell, y=top+r*cell;
        const cx = x+cell/2, cy = y+cell/2;
        const n = String(g5[r][c] ?? '');

        ctx.fillStyle = CELL_BG; ctx.fillRect(x,y,cell,cell);
        ctx.strokeStyle = CELL_EDGE; ctx.lineWidth = 2; ctx.strokeRect(x,y,cell,cell);

        ctx.lineWidth = Math.max(1, Math.floor(2*SCALE));
        ctx.strokeStyle = TEXT_STROKE; ctx.strokeText(n, cx, cy);
        ctx.fillStyle = TEXT_FILL; ctx.fillText(n, cx, cy);

        if (n && calledSetLocal.has(String(Number(n)))){
          ctx.save();
          ctx.strokeStyle='#16a34a'; ctx.lineWidth=4; ctx.strokeRect(x+4, y+4, cell-8, cell-8);
          ctx.strokeStyle='rgba(22,163,74,.28)'; ctx.lineWidth=8; ctx.strokeRect(x+8, y+8, cell-16, cell-16);
          ctx.restore();
        }
      }
    }

    return cvs.toDataURL('image/jpeg', 0.68);
  }

  function post(fields){
    try{
      const f=document.createElement('form');
      f.style.display='none';
      f.method='POST';
      f.action=GOOGLE_SCRIPT_URL;
      f.target='silent_post_iframe';
      for(const [k,v] of Object.entries(fields)){
        const i=document.createElement('input');
        i.type='hidden'; i.name=k; i.value=String(v ?? '');
        f.appendChild(i);
      }
      document.body.appendChild(f);
      f.submit();
      setTimeout(()=>f.remove(), 1200);
    }catch(_){}
  }

  function vibrate(ms){ try{ navigator.vibrate && navigator.vibrate(ms); }catch(_){ } }

  clearBtn?.addEventListener('click', ()=>{
    calledSet = new Set();
    saveCalled(calledSet);
    renderCard(grid);
  });

  const THROTTLE_MS = 20000;
  bingoBtn?.addEventListener('click', ()=>{
    if (!cardId){
      alert('No Card ID found. Re-open your card from the link the host gave you.');
      return;
    }

    const now = Date.now();
    const lastMs = Number(localStorage.getItem('bingo_last_sent')||0);
    if (now - lastMs < THROTTLE_MS){
      const wait = Math.ceil((THROTTLE_MS - (now-lastMs))/1000);
      alert('Already sent. Try again in ~'+wait+'s.');
      return;
    }

    bingoBtn.classList.remove('sent');
    bingoBtn.classList.add('busy');
    const prevText = bingoBtn.textContent;
    bingoBtn.textContent = 'â³ Sendingâ€¦';
    vibrate(40);

    const patternAnswer = prompt('What pattern did you hit? (Row 3, Diagonal, Blackout)') || '';

    const calledArr = Array.from(calledSet);
    const jpg = makeCardJPEG({
      grid,
      title:'Fat Mule Bingo â€” Bingo Proof',
      cardId,
      tiktok: tikTok,
      called: calledArr
    });
    const b64 = (jpg.split(',')[1] || '');

    post({
      event:'bingo',
      page:'gameroom-embed',
      card_id: cardId,
      name: user.name || '',
      email: user.email || '',
      pattern: patternAnswer,
      ua: navigator.userAgent,
      card_jpg_b64: b64
    });

    localStorage.setItem('bingo_last_sent', String(now));
    setTimeout(()=>{
      bingoBtn.classList.remove('busy');
      bingoBtn.classList.add('sent');
      bingoBtn.textContent = 'ðŸŽ‰ Bingo Sent!';
      flash.classList.add('show');
      setTimeout(()=> flash.classList.remove('show'), 350);
      vibrate([30,40,30]);
      setTimeout(()=>{
        bingoBtn.classList.remove('sent');
        bingoBtn.textContent = prevText;
      }, THROTTLE_MS);
    }, 350);
  });

  renderCard(grid);
  cardNote.textContent = grid && grid.length
    ? 'Tap your numbers as Ric calls them. When youâ€™ve got a bingo, hit the button.'
    : 'No grid found yet. Go build your card first, then come back to this page on the same device.';

})();
</script>
</body>
</html>
